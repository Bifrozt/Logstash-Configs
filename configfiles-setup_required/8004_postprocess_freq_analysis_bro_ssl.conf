# Author: Justin Henderson
# Email: jhenderson@tekrefresh.comes
# Last Update: 5/10/2016
#
# This conf file is based on accepting logs for ssl.log from Bro systems
filter {
  if [type] == "bro_ssl" {
    # If CHANGE_ME exists run a frequency analysis against it.  In order for this to work you must have
    # freq.py and the corresponding frequency table in /opt/freq/.  This is a huge boost to security
    # and I highly recommend you set this up.  Example, if a frequency score less than 6 exists
    # then there is a likelihood that something malicious is happening.
    #
    # For higher accuracy, please generate your own frequency tables.  For questions on setup,
    # please refer to https://github.com/SMAPPER
    if [subject_common_name] or [server_name] != "-"{
      if [server_name] != "-" {
        ruby {
          code => "freq_query = URI.escape(event['server_name']); event['frequency_score'] = `/usr/bin/curl -s http://127.0.0.1:10004?cmd=measure\\&tgt=#{freq_query}`"
        }
        mutate {
          convert => [ "frequency_score", "float" ]
        }
      } else {
        ruby {
          code => "freq_query = URI.escape(event['subject_common_name']); event['frequency_score'] = `/usr/bin/curl -s http://127.0.0.1:10004?cmd=measure\\&tgt=#{freq_query}`"
        }
        mutate {
          convert => [ "frequency_score", "float" ]
        }
      }
    }
  }	
}
